<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>プロジェクト - RYUDDI Portfolio</title>
  <meta name="description" content="テーマごとに作品群をまとめたポートフォリオ。畑ロボット（2023）、山・稲作文化（2024）、季節・土地とともに生きる（2025）。">
  <meta name="robots" content="index,follow">
  <meta name="theme-color" content="#fcfaf7">
  <link rel="canonical" href="https://ryujikoyasu.github.io/ryuddi-site/projects.html">
  <link rel="stylesheet" href="style.css?v=3">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="icons/ohana-mandala.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/logo-192.png">
  <link rel="mask-icon" href="icons/ohana-mandala.svg" color="#8E354A">
  <style>
    .projects-hero {
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 18px 16px 14px;
      text-align: center;
      background: #fff;
      border-bottom: 1px solid #eee;
    }

    .projects-hero h1 {
      font-size: 28px;
      margin: 0 0 4px;
      letter-spacing: .02em;
    }

    .projects-hero p {
      color: #5b5b5b;
      margin: 0;
      font-size: 14px;
    }

    .theme-section {
      padding: 28px 16px;
    }

    .theme-header {
      max-width: 960px;
      margin: 0 auto 16px;
    }

    .theme-title {
      font-size: 22px;
      margin: 0 0 6px;
    }

    .theme-desc {
      color: #6b6b6b;
      margin: 0;
    }

    .projects-grid {
      display: grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      gap: 16px;
      max-width: 1080px;
      margin: 0 auto;
    }

    @media (min-width: 640px) {
      .projects-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (min-width: 960px) {
      .projects-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .card {
      display: block;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 12px;
      overflow: hidden;
      transition: transform .15s ease, box-shadow .15s ease;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, .06);
    }

    .card-fig {
      aspect-ratio: 4/3;
      background: #f3f3f3;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-fig img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .card-body {
      padding: 12px 14px 14px;
    }

    .card-title {
      font-size: 16px;
      margin: 0 0 4px;
    }

    .card-meta {
      font-size: 12px;
      color: #777;
    }

    .card-lead {
      font-size: 13px;
      color: #4a4a4a;
      margin: 6px 0 0;
      line-height: 1.5;
    }

    .media-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .media-chips .chip {
      font-size: 11px;
      padding: 4px 8px;
      border: 1px solid #e5e5e5;
      border-radius: 999px;
      background: #fafafa;
    }

    /* Scrollytelling flow (compact, subtle) */
    .flow-wrap {
      position: relative;
      height: calc(var(--flowH, 70vh) * var(--steps, 4));
      margin: 12px 0 8px;
    }

    .flow-wrap.reduce {
      height: auto;
    }

    .flow-pin {
      position: sticky;
      top: var(--heroH, 80px);
      height: var(--flowH, 70vh);
      overflow: hidden;
      background: transparent;
    }

    .flow-stage {
      position: relative;
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: minmax(200px, 300px) 1fr;
      gap: 24px;
      align-items: center;
    }

    .flow-left {
      position: relative;
      z-index: 2;
      align-self: center;
      justify-self: start;
      padding-left: 16px;
    }

    .flow-right {
      position: relative;
      z-index: 1;
      height: 100%;
    }

    .flow-media {
      position: absolute;
      inset: 0;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .06);
      background: #000;
      /* 黒背景を追加 */
    }

    .flow-media .group {
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity .4s ease;
    }

    .flow-media .group.is-group-on {
      opacity: 1;
    }

    /* Perfect cross-fade: Outgoing item waits (delay), Incoming item fades in immediately */
    .flow-media .group>* {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      opacity: 0;
      transition: opacity 0.5s ease 0.5s;
      /* Delay fade-out so new image covers it first */
      z-index: 0;
    }

    .flow-media .group>*.is-on {
      opacity: 1;
      transition: opacity 0.5s ease 0s;
      /* Immediate fade-in */
      z-index: 1;
    }

    .flow-headlines {
      list-style: none;
      padding: 0;
      margin: 0 10px 10px 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      border-left: 2px solid #eee;
      padding-left: 16px;
    }

    .headline-item {
      font-size: 18px;
      letter-spacing: .01em;
      color: #222;
      opacity: .4;
      transition: opacity .25s ease, font-weight .25s ease, transform 0.25s ease;
      position: relative;
      cursor: pointer;
      /* クリック可能に */
    }

    .headline-item:hover {
      opacity: 0.7;
    }

    .headline-item .year {
      font-weight: 600;
      margin-right: 8px;
      font-size: 0.9em;
    }

    .headline-item.active {
      opacity: 1;
      font-weight: 700;
      transform: translateX(4px);
      color: var(--accent-color-2);
    }

    /* Progress indicator */
    .flow-progress-bar {
      position: absolute;
      left: -2px;
      top: 0;
      width: 2px;
      height: 0;
      background: var(--accent-color-2);
      transition: height 0.1s linear;
    }

    .flow-lead {
      margin: 8px 0 0;
      font-size: 13px;
      color: #444;
      line-height: 1.7;
      max-width: 48ch;
    }

    .flow-title {
      margin: 0 0 4px;
      font-size: 16px;
    }

    .flow-text {
      margin: 0;
      color: #4a4a4a;
      line-height: 1.7;
      font-size: 13px;
    }

    .flow-dots {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .flow-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #e5e5e5;
      border: 2px solid #fff;
      box-shadow: 0 0 0 1px #ddd;
    }

    .flow-dot.active {
      background: #9ca3af;
    }
  </style>
  <script>
    async function loadProjects() {
      const container = document.getElementById('themes');
      const placeholder = document.getElementById('themes-loading');
      if (!container) return; // themes を表示しない構成なら何もしない
      try {
        const base = new URL(document.currentScript?.src || 'projects.html', document.baseURI).pathname.replace(/\/[^\/]*$/, '/');
        const res = await fetch(base + 'content/projects/index.json', { credentials: 'same-origin' });
        if (!res.ok) throw new Error('Failed to load index.json');
        const data = await res.json();

        // Theme metadata (editable via content/projects/themes.json later)
        const themes = [
          { id: '畑ロボット', year: 2023, title: '畑ロボット', desc: '農と暮らしから立ち上がるロボット群。ローカル知と実装の往復。' },
          { id: '山、稲作文化', year: 2024, title: '山、稲作文化', desc: '地形と水、稲作の所作。土地の記憶とものづくり。' },
          { id: '季節、土地とともに生きる', year: 2025, title: '季節、土地とともに生きる', desc: '季節の変化と素材の呼吸に同調する試作と空間。' }
        ];

        // Normalize and group
        const itemsRaw = (data.projects || []).map(p => ({
          id: p.id,
          title: p.title,
          year: p.year,
          theme: p.theme || p.parentTheme || '',
          featured: !!p.featured,
          lead: p.lead || '',
          media: p.media || [],
          category: p.category || [],
          thumbnail: p.thumbnail,
          path: p.path
        }));
        // Projects page is curated: show only featured
        const items = itemsRaw.filter(p => p.featured);

        // If theme is missing, try to infer from id
        const infer = (id) => {
          if (!id) return '';
          if (id.includes('robot')) return '畑ロボット';
          return '';
        };
        items.forEach(p => { if (!p.theme) p.theme = infer(p.id); });

        // Group by theme id
        const byTheme = new Map();
        items.forEach(p => {
          const t = p.theme || 'その他';
          if (!byTheme.has(t)) byTheme.set(t, []);
          byTheme.get(t).push(p);
        });

        // Render in theme order
        container.innerHTML = '';
        const relData = await loadRelations();
        themes.forEach(t => {
          const list = (byTheme.get(t.id) || []).filter(p => p.featured);
          if (!list.length) return;
          const section = document.createElement('section');
          section.className = 'theme-section';
          const head = document.createElement('div');
          head.className = 'theme-header';
          head.innerHTML = `<h2 class="theme-title">${t.year}｜${t.title}</h2><p class="theme-desc">${t.desc}</p>`;
          section.appendChild(head);
          const grid = document.createElement('div');
          grid.className = 'projects-grid';
          const fallbackThumb = 'content/projects/sample_project/thumb.svg';
          list.forEach(p => {
            const a = document.createElement('a');
            a.className = 'card';
            a.href = p.path || '#';
            a.innerHTML = `
              <div class="card-fig">${p.thumbnail ? `<img src="${p.thumbnail}" alt="${p.title}">` : `<img src="${fallbackThumb}" alt="${p.title}">`}</div>
              <div class="card-body">
                <h3 class="card-title">${p.title || ''}</h3>
                <div class="card-meta">${(p.year || '')}${(p.category && p.category.length) ? ' ・ ' + p.category.join(', ') : ''}</div>
                ${p.lead ? `<p class="card-lead">${p.lead}</p>` : ''}
                ${p.media && p.media.length ? `<div class="media-chips">${p.media.map(m => `<span class="chip">${m}</span>`).join('')}</div>` : ''}
              </div>
            `;
            grid.appendChild(a);
          });
          section.appendChild(grid);
          if (relData && list.length) {
            const rel = buildThemeRelations(list, relData);
            if (rel.techs.length) {
              const relBox = document.createElement('div');
              relBox.style.maxWidth = '960px';
              relBox.style.margin = '12px auto 0';
              relBox.innerHTML = `<div style="font-size:13px;color:#666;margin:6px 0;">関係の糸（共有する技法）</div>`;
              const chips = document.createElement('div');
              chips.style.display = 'flex';
              chips.style.flexWrap = 'wrap';
              chips.style.gap = '8px';
              rel.techs.forEach(tk => {
                const b = document.createElement('button');
                b.className = 'chip'; b.type = 'button';
                b.textContent = `${tk.label} (${tk.count})`;
                b.addEventListener('click', () => openRelated(rel, tk.key, section));
                chips.appendChild(b);
              });
              relBox.appendChild(chips);
              const relList = document.createElement('div');
              relList.className = 'projects-grid';
              relList.style.marginTop = '10px';
              relList.setAttribute('data-rel-list', '');
              relBox.appendChild(relList);
              section.appendChild(relBox);
            }
          }
          container.appendChild(section);
        });
      } catch (e) {
        console.warn(e);
        const err = document.createElement('p');
        err.textContent = 'プロジェクトの読み込みに失敗しました。';
        container.innerHTML = '';
        container.appendChild(err);
      } finally {
        if (placeholder) placeholder.remove();
        // Init any shared JS behaviors after dynamic render
        try { window.__initMediaGalleries && window.__initMediaGalleries(); } catch (e) { }
      }
    }
    document.addEventListener('DOMContentLoaded', loadProjects);

    // Measure sticky hero height to offset the pinned flow nicely
    function setHeroHeight() {
      try {
        const hero = document.querySelector('.projects-hero');
        if (!hero) return;
        const h = hero.offsetHeight || 0;
        document.documentElement.style.setProperty('--heroH', h + 'px');
      } catch (e) { }
    }
    document.addEventListener('DOMContentLoaded', setHeroHeight);
    window.addEventListener('resize', setHeroHeight);

    // Pinned vertical flow (left text + right media, continuous fade)
    function initProjectFlow() {
      const wrap = document.getElementById('project-flow');
      if (!wrap) return;
      const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (reduce) { wrap.classList.add('reduce'); return; }
      const heads = Array.from(wrap.querySelectorAll('.headline-item'));
      const mediaRoot = document.getElementById('flow-media');
      // Build multi-media groups per year (2023-2026)
      const mediaGroups = [
        [ // 2023
          { t: 'video', src: 'content/projects/畑ロボット/ohana-robot/images/ハイライトshort.mp4', type: 'video/mp4' }
        ],
        [ // 2024
          { t: 'video', src: 'content/projects/山、稲作文化/vernacular-rice-robot/images/inasakurobo.mov', type: 'video/quicktime' },
          { t: 'img', src: 'content/projects/山、稲作文化/akebi-tengu/images/_A749585.jpg' },
          { t: 'img', src: 'content/projects/山、稲作文化/akebi-tengu/images/_A749589.jpg' },
          { t: 'img', src: 'content/projects/山、稲作文化/akebi-tengu/images/_A749596.jpg' },
          { t: 'img', src: 'content/projects/山、稲作文化/katamenyo/images/_A749576.jpg' }
        ],
        [ // 2025
          { t: 'video', src: 'content/projects/季節、土地とともに生きる/cases/ohana-ike/video.mp4', type: 'video/mp4' },
          { t: 'video', src: 'content/projects/季節、土地とともに生きる/cases/shishi-odoshi/video.mp4', type: 'video/mp4' }
        ],
        [ // 2026
          { t: 'img', src: 'content/projects/sample_project/thumb.svg' }
        ]
      ];
      // Reset and construct DOM
      mediaRoot.innerHTML = '';
      const groupEls = mediaGroups.map(group => {
        const g = document.createElement('div'); g.className = 'group';
        group.forEach(item => {
          if (item.t === 'video') {
            const v = document.createElement('video'); v.className = 'flow-vid'; v.muted = true; v.playsInline = true; v.preload = 'metadata';
            // 単一アイテムの場合はループ、複数の場合はループしない（終わったら次へ）
            if (group.length === 1) { v.loop = true; } else { v.loop = false; }

            const s = document.createElement('source'); s.src = item.src; if (item.type) s.type = item.type; v.appendChild(s);
            g.appendChild(v);
          } else {
            const i = document.createElement('img'); i.className = 'flow-img'; i.src = item.src; i.alt = ''; g.appendChild(i);
          }
        });
        mediaRoot.appendChild(g); return g;
      });
      const groupFrame = new Array(mediaGroups.length).fill(0);
      const leadEl = document.getElementById('flow-lead');
      const leads = [
        '畑で立ち上がる要件と、身体拡張としての道具観。フィールドの具体から、最小構成で応える。',
        '山に入る。地形と水に同調し、稲作や民俗の所作から、道具観を更新していく。',
        '季節と土地の呼吸に合わせ、衣・空間・光と音を編む。暮らしそのものが表現となる。',
        '京都へ——土地を変え、連続の先で新たな編み直しへ。'
      ];
      const steps = heads.length;
      let lastIdx = -1;
      let activeIdx = 0;
      let cycleTimer = null;

      function scheduleNext(groupIdx) {
        clearTimeout(cycleTimer);
        const g = groupEls[groupIdx];
        if (!g) return;
        const children = Array.from(g.children);
        if (children.length <= 1) return; // 1つだけなら切り替え不要

        const currentFrame = groupFrame[groupIdx] % children.length;
        const currentEl = children[currentFrame];

        let delay = 4000; // デフォルト（画像など）は4秒

        if (currentEl.tagName === 'VIDEO') {
          // 動画の場合は再生終了を待つ
          // すでに再生中のはずだが、念のためイベントリスナーを設定
          if (currentEl.ended) {
            nextFrame(groupIdx);
            return;
          }
          currentEl.onended = () => {
            currentEl.onended = null; // リスナー解除
            nextFrame(groupIdx);
          };
          return; // タイマーはセットせず、イベント待ち
        }

        // 画像の場合はタイマーで切り替え
        cycleTimer = setTimeout(() => {
          nextFrame(groupIdx);
        }, delay);
      }

      function nextFrame(groupIdx) {
        if (groupIdx !== activeIdx) return; // 別のグループに移っていたら何もしない
        groupFrame[groupIdx]++;
        updateGroupMedia(groupIdx, true); // 次のアイテムに行くときはリセットする
        scheduleNext(groupIdx); // 次のスケジュール
      }

      function updateGroupMedia(idx, shouldReset = false) {
        const g = groupEls[idx]; if (!g) return;
        const children = Array.from(g.children);
        const fi = groupFrame[idx] % Math.max(1, children.length);

        children.forEach((c, i) => {
          const isActive = (i === fi);
          c.classList.toggle('is-on', isActive);

          if (c.tagName === 'VIDEO') {
            if (isActive) {
              if (shouldReset) c.currentTime = 0; // リセットフラグがある時だけ最初から
              c.play().catch(() => { });
            } else {
              c.pause();
            }
          }
        });
      }

      function setActive(idx) {
        groupEls.forEach((g, i) => {
          const isActive = (i === idx);
          g.classList.toggle('is-group-on', isActive);

          // 非アクティブなグループの動画は停止
          if (!isActive) {
            Array.from(g.querySelectorAll('video')).forEach(v => v.pause());
          }
        });

        // アクティブなグループの処理開始
        clearTimeout(cycleTimer);
        updateGroupMedia(idx, false); // 切り替え時はリセットしない（続きから）
        scheduleNext(idx);
      }
      function onScroll() {
        const rect = wrap.getBoundingClientRect();
        const total = Math.max(1, wrap.offsetHeight - window.innerHeight);
        // スクロール位置の計算を少し調整（画面中央付近で切り替わるように）
        const offset = window.innerHeight * 0.3;
        const scrolled = Math.min(Math.max(-rect.top + offset, 0), total);

        const idxF = (scrolled / Math.max(1, total)) * (steps - 1);
        const idx = Math.min(steps - 1, Math.max(0, Math.round(idxF))); // floorからroundに変更して、より近い方にスナップ

        heads.forEach((el, i) => {
          const d = Math.abs(idxF - i);
          const opacity = Math.max(0.2, 1 - d * 0.9);
          el.style.opacity = String(opacity);
          el.classList.toggle('active', i === idx);
        });

        // Update progress bar
        const progressBar = document.getElementById('flow-progress');
        if (progressBar) {
          const progress = Math.min(1, scrolled / Math.max(1, total));
          progressBar.style.height = (progress * 100) + '%';
        }

        if (activeIdx !== idx) {
          activeIdx = idx;
          setActive(activeIdx);
        }
        if (leadEl && lastIdx !== idx) leadEl.textContent = leads[idx] || '';
        lastIdx = idx;
      }
      setActive(activeIdx);
      onScroll();
      window.addEventListener('scroll', onScroll, { passive: true });
      window.addEventListener('resize', onScroll);

      // Click to navigate
      heads.forEach((el, i) => {
        el.addEventListener('click', () => {
          const rect = wrap.getBoundingClientRect();
          const total = Math.max(1, wrap.offsetHeight - window.innerHeight);
          const stepH = total / (steps - 1);
          const wrapTop = rect.top + window.pageYOffset;
          // 少し調整して、対象のセクションが心地よい位置に来るように
          const targetY = wrapTop + (i * stepH) - (window.innerHeight * 0.1);

          window.scrollTo({
            top: targetY,
            behavior: 'smooth'
          });
        });
      });


    }
    document.addEventListener('DOMContentLoaded', initProjectFlow);

    async function loadRelations() {
      try {
        let path = 'data/works-manifest.json';
        const p = location.pathname; const idx = p.indexOf('/works/');
        if (idx !== -1) path = p.slice(0, idx + 1) + 'data/works-manifest.json';
        const res = await fetch(path, { credentials: 'same-origin' });
        if (!res.ok) return null; return res.json();
      } catch (e) { return null; }
    }
    function buildThemeRelations(themeItems, manifest) {
      const urls = new Set((themeItems || []).map(i => i.path).filter(Boolean));
      const relWorks = (manifest || []).filter(w => urls.has(w.url));
      const byTech = new Map();
      relWorks.forEach(w => (w.techs || []).forEach(t => { if (!byTech.has(t)) byTech.set(t, []); byTech.get(t).push(w); }));
      const techs = Array.from(byTech.entries()).map(([k, arr]) => ({ key: k, label: k.replace('kusaki:', '草木染：').replace('kusabana', '草花拓'), count: arr.length })).sort((a, b) => b.count - a.count);
      return { techs, byTech };
    }
    function openRelated(rel, techKey, section) {
      if (!section) return;
      const list = rel.byTech.get(techKey) || [];
      const holder = section.querySelector('[data-rel-list]');
      if (!holder) return;
      holder.innerHTML = '';
      const fallbackThumb = 'content/projects/sample_project/thumb.svg';
      list.forEach(w => {
        const a = document.createElement('a'); a.className = 'card'; a.href = w.url;
        a.innerHTML = `
          <div class="card-fig"><img src="${w.cover || fallbackThumb}" alt="${w.title}"></div>
          <div class="card-body"><h3 class="card-title">${w.title}</h3></div>
        `;
        holder.appendChild(a);
      });
      try { window.__initMediaGalleries && window.__initMediaGalleries(); } catch (e) { }
    }
  </script>
</head>

<body>
  <a href="#main-content" class="skip-link">コンテンツへスキップ</a>
  <div class="cursor"></div>
  <header id="site-header" role="banner"></header>

  <main id="main-content">
    <section class="projects-hero">
      <h1>テーマで巡るポートフォリオ</h1>
      <p>モチーフから世界観が立ち上がる制作の軌跡。</p>
    </section>
    <section aria-label="プロジェクトの流れ" id="project-flow" class="flow-wrap" style="--steps:4; --flowH:70vh;">
      <div class="flow-pin">
        <div class="flow-stage">
          <div class="flow-left">
            <ul class="flow-headlines">
              <div class="flow-progress-bar" id="flow-progress"></div>
              <li class="headline-item active"><span class="year">2023</span>畑ロボット</li>
              <li class="headline-item"><span class="year">2024</span>山・稲作文化</li>
              <li class="headline-item"><span class="year">2025</span>季節、土地とともに生きる</li>
              <li class="headline-item"><span class="year">2026</span>京都へ</li>
            </ul>
            <p class="flow-lead" id="flow-lead">畑で立ち上げた道具観が、山と稲作を経て、季節と土地の呼吸へと続いていく。</p>
          </div>
          <div class="flow-right">
            <div class="flow-media" id="flow-media">
              <img src="content/projects/sample_project/thumb.svg" alt="2023" class="flow-img is-on">
              <img src="content/projects/sample_project/thumb.svg" alt="2024" class="flow-img">
              <video class="flow-vid" muted autoplay loop playsinline preload="metadata">
                <source src="content/projects/季節、土地とともに生きる/cases/ohana-ike/video.mp4" type="video/mp4">
              </video>
              <img src="content/projects/sample_project/thumb.svg" alt="2026" class="flow-img">
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <script src="script.js?v=3"></script>
</body>

</html>
